{% comment %}
  DK Mega Menu Snippet
  
  Renders individual mega menus per menu item when dk_mega_menu style is selected.
  
  Accepts:
  - block: The header menu block with settings
{% endcomment %}

{% liquid
  assign animation_speed = 200
  assign color_scheme_classes = ''
  assign color_scheme_setting_id = 'color_scheme_' | append: section.settings.menu_row
  assign current_color_scheme = block.settings.color_scheme
  assign parent_color_scheme = section.settings[color_scheme_setting_id]

  if parent_color_scheme.id != current_color_scheme.id
    assign color_scheme_classes = ' color-' | append: current_color_scheme
  endif

  if parent_color_scheme.settings.background.rgb == current_color_scheme.settings.background.rgb
    assign color_scheme_classes = color_scheme_classes | append: ' color-scheme-matches-parent'
  endif
%}

{% capture children %}
  {% assign desktop_limit = block.settings.desktop_menu_items_limit | default: 3 %}
  {% assign total_links = block.settings.menu.links.size %}
  
  {% for link in block.settings.menu.links %}
    {% comment %}
      Add custom class for items that should be hidden on desktop if they exceed the limit
    {% endcomment %}
    {% assign item_classes = 'menu-list__list-item' %}
    {% if forloop.index > desktop_limit %}
      {% assign item_classes = item_classes | append: ' dk-mega-menu__overflow-item' %}
    {% endif %}
    
    <li
      role="presentation"
      class="{{ item_classes }}"
      on:focus="/activate"
      on:blur="/deactivate"
      on:pointerenter="/activate"
      on:pointerleave="/deactivate"
    >
      <a
        role="menuitem"
        aria-haspopup="true"
        href="{{ link.url }}"
        class="menu-list__link{% if link.active %} menu-list__link--active{% endif %}"
      >
        <span class="menu-list__link-title">{{- link.title -}}</span>
      </a>
      
      <!-- DK Mega Menu submenu for each link -->
      <div class="menu-list__submenu{{ color_scheme_classes }}" ref="submenu[]">
        <div class="menu-list__submenu-inner">
          {% assign link_handle = link.handle | downcase %}
          
          {% comment %}
            Show mega menu only for "shop" menu item, regular dropdowns for others
          {% endcomment %}
          {% if link_handle == 'shop' or link_handle contains 'shop' %}
            <!-- Full Mega Menu for Shop -->
            {% render 'dk_mega-menu-content', block: block, link: link %}
          {% elsif link.links != blank %}
            <!-- Regular dropdown for other menu items -->
            {% render 'mega-menu', parent_link: link, id: 'RegularMenu-' | append: forloop.index, menu_content_type: 'text' %}
          {% else %}
            <!-- Simple link with no dropdown -->
            <div class="simple-menu-placeholder"></div>
          {% endif %}
        </div>
      </div>
    </li>
  {% endfor %}
{% endcapture %}

<header-menu
  ref="headerMenu"
  class="header-menu header-menu--mega mobile:hidden"
  data-animation-delay="{{ animation_speed }}"
  {{ block.shopify_attributes }}
  style="--submenu-animation-speed: {{ animation_speed }}ms;"
>
  <nav header-menu>
    <div class="menu-list" style="{% render 'menu-font-styles', settings: block.settings %}">
      {% assign class = 'overflow-menu' | append: color_scheme_classes %}
      {% assign desktop_limit = block.settings.desktop_menu_items_limit | default: 3 %}
      {% render 'overflow-list', class: class, ref: 'overflowMenu', children: children, minimum-items: desktop_limit %}
    </div>
  </nav>

  <script
    src="{{ 'header-menu.js' | asset_url }}"
    type="module"
  ></script>
</header-menu>

{% render 'dk_mega-menu-styles' %}
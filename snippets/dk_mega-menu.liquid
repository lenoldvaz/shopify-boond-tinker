{% comment %}
  DK Mega Menu Snippet
  
  Renders the mega menu when the dk_mega_menu style is selected in header menu.
  
  Accepts:
  - block: The header menu block with settings
{% endcomment %}

{% liquid
  assign animation_speed = 200
%}

<div class="dk-mega-menu-container mobile:hidden" {{ block.shopify_attributes }}>
  <!-- Show the mega menu content directly -->
  <div
    class="
      dk-mega-menu
      layout-panel-flex
      layout-panel-flex--row
      color-{{ block.settings.color_scheme | default: 'scheme-1' }}
      {% if block.settings.vertical_on_mobile %}mobile-column{% endif %}
    "
    style="
      {% render 'gap-style', value: block.settings.gap_desktop | default: 32, mobile_value: block.settings.gap_mobile | default: 24 %}
      background: var(--color-background);
      padding: var(--padding-lg);
      border-radius: var(--style-border-radius);
    "
    data-testid="dk-mega-menu"
  >
      <!-- Navigation Categories -->
      {% if block.settings.show_nav_categories %}
        <div class="dk-mega-menu__nav-section">
          <div class="dk-nav-categories">
            <nav class="dk-nav-categories__nav" role="navigation">
              <ul class="dk-nav-categories__list list-unstyled" role="list">
                {% assign categories = block.settings.nav_categories | default: 'Best Sellers,Build Your Own Bundle,Subscribe & Save' | split: ',' %}
                {% assign links = block.settings.nav_category_links | default: '/collections/best-sellers,/pages/build-bundle,/pages/subscribe' | split: ',' %}
                
                {% for category in categories %}
                  <li class="dk-nav-categories__item">
                    {% assign category_trimmed = category | strip %}
                    {% assign link_index = forloop.index0 %}
                    {% assign link_url = links[link_index] | strip | default: '#' %}
                    
                    <a 
                      href="{{ link_url }}" 
                      class="dk-nav-categories__link"
                    >
                      {{ category_trimmed }}
                    </a>
                  </li>
                {% endfor %}
              </ul>
            </nav>
          </div>
        </div>
      {% endif %}

      <!-- Skincare Menu Column -->
      {% if block.settings.skincare_menu != blank %}
        <div class="dk-mega-menu__column-section">
          <div class="dk-menu-column">
            <h3 class="dk-menu-column__title">{{ block.settings.skincare_title | default: 'Shop Skincare' }}</h3>
            <ul class="dk-menu-column__list list-unstyled" role="list">
              {% assign max_links = block.settings.max_links | default: 8 %}
              {% for link in block.settings.skincare_menu.links limit: max_links %}
                <li class="dk-menu-column__item">
                  <a 
                    href="{{ link.url }}" 
                    class="dk-menu-column__link"
                    {% if link.current %}aria-current="page"{% endif %}
                  >
                    {{ link.title }}
                  </a>
                </li>
              {% endfor %}
              
              {% if block.settings.show_shop_all %}
                <li class="dk-menu-column__item dk-menu-column__item--shop-all">
                  <a 
                    href="{{ block.settings.skincare_menu.url }}" 
                    class="dk-menu-column__link dk-menu-column__link--shop-all"
                  >
                    {{ block.settings.shop_all_text | default: 'SHOP ALL' }}
                  </a>
                </li>
              {% endif %}
            </ul>
          </div>
        </div>
      {% endif %}

      <!-- Haircare Menu Column -->
      {% if block.settings.haircare_menu != blank %}
        <div class="dk-mega-menu__column-section">
          <div class="dk-menu-column">
            <h3 class="dk-menu-column__title">{{ block.settings.haircare_title | default: 'Shop Haircare' }}</h3>
            <ul class="dk-menu-column__list list-unstyled" role="list">
              {% assign max_links = block.settings.max_links | default: 8 %}
              {% for link in block.settings.haircare_menu.links limit: max_links %}
                <li class="dk-menu-column__item">
                  <a 
                    href="{{ link.url }}" 
                    class="dk-menu-column__link"
                    {% if link.current %}aria-current="page"{% endif %}
                  >
                    {{ link.title }}
                  </a>
                </li>
              {% endfor %}
              
              {% if block.settings.show_shop_all %}
                <li class="dk-menu-column__item dk-menu-column__item--shop-all">
                  <a 
                    href="{{ block.settings.haircare_menu.url }}" 
                    class="dk-menu-column__link dk-menu-column__link--shop-all"
                  >
                    {{ block.settings.shop_all_text | default: 'SHOP ALL' }}
                  </a>
                </li>
              {% endif %}
            </ul>
          </div>
        </div>
      {% endif %}

      <!-- Featured Products Carousel -->
      {% if block.settings.show_featured_products and block.settings.featured_collection != blank %}
        <div class="dk-mega-menu__featured-section">
          {% liquid
            assign collection = collections[block.settings.featured_collection]
            assign products_to_show = block.settings.products_to_show | default: 5
            assign products = collection.products | limit: products_to_show
          %}

          <div class="dk-featured-carousel">
            {% if block.settings.carousel_title != blank %}
              <div class="dk-featured-carousel__header">
                <h3 class="dk-featured-carousel__title">
                  {{ block.settings.carousel_title }}
                </h3>
                {% if products.size > 1 %}
                  <div class="dk-featured-carousel__counter">
                    <span class="dk-featured-carousel__current">1</span>/<span class="dk-featured-carousel__total">{{ products.size }}</span>
                  </div>
                {% endif %}
              </div>
            {% endif %}

            {% if products.size > 0 %}
              <div class="dk-featured-carousel__slideshow" data-carousel>
                {% for product in products %}
                  <div class="dk-featured-carousel__slide" {% if forloop.first %}style="display: block;"{% else %}style="display: none;"{% endif %} data-slide="{{ forloop.index0 }}">
                    <div class="dk-featured-carousel__product-card">
                      {% if product.featured_image %}
                        <div class="dk-featured-carousel__image-wrapper">
                          {% if product.compare_at_price > product.price and block.settings.show_sale_badges %}
                            {% assign discount_percentage = product.compare_at_price | minus: product.price | times: 100 | divided_by: product.compare_at_price | round %}
                            <div class="dk-featured-carousel__sale-badge">
                              Save {{ discount_percentage }}%
                            </div>
                          {% endif %}
                          
                          <img
                            src="{{ product.featured_image | image_url: width: 300 }}"
                            alt="{{ product.featured_image.alt | escape }}"
                            width="300"
                            height="300"
                            loading="lazy"
                            class="dk-featured-carousel__image"
                          >
                        </div>
                      {% endif %}

                      <div class="dk-featured-carousel__content">
                        <h4 class="dk-featured-carousel__product-title">
                          <a href="{{ product.url }}" class="dk-featured-carousel__product-link">
                            {{ product.title }}
                          </a>
                        </h4>

                        {% if block.settings.show_descriptions and product.description != blank %}
                          <div class="dk-featured-carousel__description">
                            {{ product.description | strip_html | truncate: 100 }}
                          </div>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>

              {% if products.size > 1 %}
                <div class="dk-featured-carousel__navigation">
                  <button class="dk-featured-carousel__nav-btn dk-featured-carousel__nav-btn--prev" data-carousel-prev>‹</button>
                  <button class="dk-featured-carousel__nav-btn dk-featured-carousel__nav-btn--next" data-carousel-next>›</button>
                </div>
              {% endif %}
            {% endif %}
          </div>
        </div>
      {% endif %}
  </div>
</div>

{% render 'dk_mega-menu-styles' %}
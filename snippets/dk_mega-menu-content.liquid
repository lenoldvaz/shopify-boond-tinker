{% comment %}
  DK Mega Menu Content Snippet
  
  Contains the actual mega menu content for the "shop" menu item
  
  Accepts:
  - block: The header menu block with settings
  - link: The menu link being hovered
{% endcomment %}

<div
  class="
    dk-mega-menu
    layout-panel-flex
    layout-panel-flex--row
    {% if block.settings.vertical_on_mobile %}mobile-column{% endif %}
  "
  style="
    {% render 'gap-style', value: block.settings.gap_desktop | default: 32, mobile_value: block.settings.gap_mobile | default: 24 %}
  "
  data-testid="dk-mega-menu"
>
  <!-- Navigation Categories -->
  {% if block.settings.show_nav_categories %}
    <div class="dk-mega-menu__nav-section">
      <div class="dk-nav-categories">
        <nav class="dk-nav-categories__nav" role="navigation">
          <ul class="dk-nav-categories__list list-unstyled" role="list">
            {% assign categories = block.settings.nav_categories | default: 'Best Sellers,Build Your Own Bundle,Subscribe & Save' | split: ',' %}
            {% assign links = block.settings.nav_category_links | default: '/collections/best-sellers,/pages/build-bundle,/pages/subscribe' | split: ',' %}
            {% assign pills = block.settings.nav_category_pills | default: ',,HOT' | split: ',' %}
            
            {% for category in categories %}
              <li class="dk-nav-categories__item">
                {% assign category_trimmed = category | strip %}
                {% assign link_index = forloop.index0 %}
                {% assign link_url = links[link_index] | strip | default: '#' %}
                {% assign pill_text = pills[link_index] | strip %}
                
                <a 
                  href="{{ link_url }}" 
                  class="dk-nav-categories__link"
                >
                  {{ category_trimmed }}
                  {% if pill_text != blank %}
                    <span class="dk-nav-categories__pill dk-nav-categories__pill--{{ pill_text | downcase | replace: ' ', '-' }}">
                      {{ pill_text }}
                    </span>
                  {% endif %}
                </a>
              </li>
            {% endfor %}
          </ul>
        </nav>
      </div>
    </div>
  {% endif %}

  <!-- Category 1 Menu Column -->
  {% if block.settings.cat1_menu != blank %}
    <div class="dk-mega-menu__column-section">
      <div class="dk-menu-column">
        <h3 class="dk-menu-column__title">{{ block.settings.cat1_title | default: 'Shop Skincare' }}</h3>
        <ul class="dk-menu-column__list list-unstyled" role="list">
          {% assign max_links = block.settings.max_links | default: 8 %}
          {% for link in block.settings.cat1_menu.links limit: max_links %}
            <li class="dk-menu-column__item">
              <a 
                href="{{ link.url }}" 
                class="dk-menu-column__link"
                {% if link.current %}aria-current="page"{% endif %}
              >
                {{ link.title }}
              </a>
            </li>
          {% endfor %}
          
          {% if block.settings.show_shop_all %}
            <li class="dk-menu-column__item dk-menu-column__item--shop-all">
              <a 
                href="{{ block.settings.cat1_menu.url }}" 
                class="dk-menu-column__link dk-menu-column__link--shop-all"
              >
                {{ block.settings.shop_all_text | default: 'SHOP ALL' }}
              </a>
            </li>
          {% endif %}
        </ul>
      </div>
    </div>
  {% endif %}

  <!-- Category 2 Menu Column -->
  {% if block.settings.haircare_menu != blank %}
    <div class="dk-mega-menu__column-section">
      <div class="dk-menu-column">
        <h3 class="dk-menu-column__title">{{ block.settings.haircare_title | default: 'Shop Haircare' }}</h3>
        <ul class="dk-menu-column__list list-unstyled" role="list">
          {% assign max_links = block.settings.max_links | default: 8 %}
          {% for link in block.settings.haircare_menu.links limit: max_links %}
            <li class="dk-menu-column__item">
              <a 
                href="{{ link.url }}" 
                class="dk-menu-column__link"
                {% if link.current %}aria-current="page"{% endif %}
              >
                {{ link.title }}
              </a>
            </li>
          {% endfor %}
          
          {% if block.settings.show_shop_all %}
            <li class="dk-menu-column__item dk-menu-column__item--shop-all">
              <a 
                href="{{ block.settings.haircare_menu.url }}" 
                class="dk-menu-column__link dk-menu-column__link--shop-all"
              >
                {{ block.settings.shop_all_text | default: 'SHOP ALL' }}
              </a>
            </li>
          {% endif %}
        </ul>
      </div>
    </div>
  {% endif %}

  <!-- Featured Products Carousel -->
  {% if block.settings.show_featured_products and block.settings.featured_collection != blank %}
    <div class="dk-mega-menu__featured-section">
      {% liquid
        assign collection = collections[block.settings.featured_collection]
        assign products_to_show = block.settings.products_to_show | default: 5
        assign products = collection.products | limit: products_to_show
      %}

      <div class="dk-featured-carousel">
        {% if block.settings.carousel_title != blank %}
          <div class="dk-featured-carousel__header">
            <h3 class="dk-featured-carousel__title">
              {{ block.settings.carousel_title }}
            </h3>
            {% if products.size > 2 %}
              {% assign total_slides = products.size | divided_by: 2 | ceil %}
              <div class="dk-featured-carousel__counter">
                <span class="dk-featured-carousel__current">1</span>/<span class="dk-featured-carousel__total">{{ total_slides }}</span>
              </div>
            {% endif %}
          </div>
        {% endif %}

        {% if products.size > 0 %}
          <div class="dk-featured-carousel__slideshow" data-carousel>
            {% assign products_per_slide = 2 %}
            {% assign total_slides = products.size | divided_by: products_per_slide | ceil %}
            
            {% assign total_slides_minus_1 = total_slides | minus: 1 %}
            {% for i in (0..total_slides_minus_1) %}
              {% assign slide_index = i %}
              {% assign start_index = slide_index | times: products_per_slide %}
              {% assign end_index = start_index | plus: products_per_slide | minus: 1 %}
              
              {% if start_index < products.size %}
                <div class="dk-featured-carousel__slide" {% if slide_index == 0 %}style="display: flex;"{% else %}style="display: none;"{% endif %} data-slide="{{ slide_index }}">
                  {% for j in (start_index..end_index) %}
                    {% if j < products.size %}
                      {% assign product = products[j] %}
                      <div class="dk-product-card">
                        <a href="{{ product.url }}" class="dk-product-card__link">
                          {% if product.featured_media %}
                            <div class="dk-product-card__image">
                              {{ product.featured_media | image_url: width: 200 | image_tag: 
                                 loading: 'lazy',
                                 width: product.featured_media.width,
                                 height: product.featured_media.height,
                                 alt: product.featured_media.alt | escape
                              }}
                              {% if block.settings.show_sale_badges and product.compare_at_price > product.price %}
                                <div class="dk-product-card__badge">
                                  {% assign savings = product.compare_at_price | minus: product.price %}
                                  {% assign savings_percentage = savings | times: 100 | divided_by: product.compare_at_price %}
                                  Save {{ savings_percentage }}%
                                </div>
                              {% endif %}
                            </div>
                          {% endif %}
                          
                          <div class="dk-product-card__content">
                            <h4 class="dk-product-card__title">{{ product.title }}</h4>
                            {% if block.settings.show_descriptions and product.description != blank %}
                              <p class="dk-product-card__description">{{ product.description | strip_html | truncate: 80 }}</p>
                            {% endif %}
                          </div>
                        </a>
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
              {% endif %}
            {% endfor %}
          </div>

          {% if products.size > 2 %}
            <div class="dk-featured-carousel__navigation">
              <button class="dk-featured-carousel__nav-btn dk-featured-carousel__nav-btn--prev" data-carousel-prev>‹</button>
              <button class="dk-featured-carousel__nav-btn dk-featured-carousel__nav-btn--next" data-carousel-next>›</button>
            </div>
          {% endif %}
        {% endif %}
      </div>
    </div>
  {% endif %}
</div>

<script>
// Mega menu carousel functionality
(function() {
  function initCarousel() {
    const carousels = document.querySelectorAll('[data-carousel]');
    
    carousels.forEach(carousel => {
      const prevBtn = carousel.parentElement.querySelector('[data-carousel-prev]');
      const nextBtn = carousel.parentElement.querySelector('[data-carousel-next]');
      const slides = carousel.querySelectorAll('[data-slide]');
      const counter = carousel.parentElement.querySelector('.dk-featured-carousel__current');
      
      if (!carousel || slides.length === 0) return;
      
      let currentSlide = 0;
      let autoplayInterval;
      
      function showSlide(index) {
        slides.forEach((slide, i) => {
          slide.style.display = i === index ? 'flex' : 'none';
        });
        if (counter) {
          counter.textContent = index + 1;
        }
      }
      
      function nextSlide() {
        currentSlide = (currentSlide + 1) % slides.length;
        showSlide(currentSlide);
      }
      
      function prevSlide() {
        currentSlide = (currentSlide - 1 + slides.length) % slides.length;
        showSlide(currentSlide);
      }
      
      function startAutoplay() {
        // Disabled auto-scroll - no automatic carousel rotation
        stopAutoplay();
      }
      
      function stopAutoplay() {
        if (autoplayInterval) {
          clearInterval(autoplayInterval);
          autoplayInterval = null;
        }
      }
      
      // Event listeners
      if (nextBtn) {
        nextBtn.addEventListener('click', function(e) {
          e.preventDefault();
          nextSlide();
        });
      }
      
      if (prevBtn) {
        prevBtn.addEventListener('click', function(e) {
          e.preventDefault();
          prevSlide();
        });
      }
      
      // Initialize
      showSlide(0);
    });
  }
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCarousel);
  } else {
    initCarousel();
  }
  
  // Re-initialize when mega menu becomes visible (in case it's not loaded initially)
  document.addEventListener('mouseover', function(e) {
    if (e.target.closest('.header-menu--mega')) {
      setTimeout(initCarousel, 100);
    }
  });
})();
</script>
{% comment %}
  DK Upsell Product Block
  Added by DK on 2025-10-27
  
  Displays a related/upsell product with add to cart functionality
  Configured via product metafields and block settings
{% endcomment %}

{%- liquid
  # 1. Get upsell variant from product metafield
  assign upsell_variant = product.metafields.custom.upsell_product_variant.value
  
  # 2. Initialize variables
  assign also_product = nil
  assign bg_color = product.metafields.custom.upsell_block_bg.value | default: block.settings.background_color
  
  # 3. Get product from upsell variant metafield or block fallback
  if upsell_variant
    assign also_product = upsell_variant.product
    assign display_title = block.settings.title | default: also_product.title
  endif
-%}

{% comment %} DEBUG OUTPUT - Remove in production {% endcomment %}
{% if block.settings.show_debug %}
<div style="background: #f0f0f0; padding: 10px; margin: 10px 0; border: 1px solid #ccc; font-size: 12px;">
  <strong>DEBUG INFO:</strong><br>
  Upsell Variant: {{ upsell_variant.title | default: 'NOT SET' }}<br>
  Product: {{ also_product.title | default: 'NOT FOUND' }}<br>
  BG Color: {{ bg_color }}<br>
  Block Enabled: {{ block.settings.enabled }}
</div>
{% endif %}

{% if also_product and block.settings.enabled %}
  <div 
    class="dk-upsell-block"
    style="{% render 'spacing-style', settings: block.settings %}"
    {{ block.shopify_attributes }}
  >
    {% if block.settings.section_heading != blank %}
      <h3 class="dk-upsell-heading" style="
        font-family: var(--font-{{ block.settings.heading_font }}--family);
        font-weight: var(--font-{{ block.settings.heading_font }}--weight);
        font-size: {{ block.settings.heading_font_size }}px;
        color: {{ block.settings.heading_color }};
        text-transform: {{ block.settings.heading_text_transform }};
        text-align: {{ block.settings.heading_alignment }};
        margin-bottom: {{ block.settings.heading_spacing }}px;
      ">
        {{ block.settings.section_heading }}
      </h3>
    {% endif %}

    <a href="{{ also_product.url }}" class="product-also-see-link" style="display: block; text-decoration: none;">
      <div class="product-also-see-container">
        <div class="product-also-see-item" style="
          background-color: {{ bg_color }} !important;
          border-radius: {{ block.settings.card_border_radius }}px;
          border: {{ block.settings.card_border_width }}px solid {{ block.settings.card_border_color }};
        ">
          {% if block.settings.custom_image != blank %}
            <img src="{{ block.settings.custom_image | image_url: width: 300 }}" alt="{{ also_product.title }}" class="also-see-image">
          {% else %}
            <img src="{{ also_product.featured_image | image_url: width: 300 }}" alt="{{ also_product.title }}" class="also-see-image">
          {% endif %}
          
          <div class="also-see-content">
            <h4 class="also-see-title" style="
              font-family: var(--font-{{ block.settings.title_font }}--family);
              font-weight: var(--font-{{ block.settings.title_font }}--weight);
              font-size: {{ block.settings.title_font_size }}px;
              color: {{ block.settings.title_color }};
              text-transform: {{ block.settings.title_text_transform }};
            ">{{ display_title }}</h4>
            
            {% if block.settings.show_description and also_product.description != blank %}
              <p class="also-see-description">{{ also_product.description | strip_html | truncate: 80 }}</p>
            {% endif %}
            
            <div class="also-see-price">
              {% if upsell_variant and upsell_variant.compare_at_price > upsell_variant.price %}
                <span class="compare-price">{{ upsell_variant.compare_at_price | money }}</span>
                <span class="price">{{ upsell_variant.price | money }}</span>
              {% elsif also_product.compare_at_price > also_product.price %}
                <span class="compare-price">{{ also_product.compare_at_price | money }}</span>
                <span class="price">{{ also_product.price | money }}</span>
              {% else %}
                <span class="price">
                  {% if upsell_variant %}
                    {{ upsell_variant.price | money }}
                  {% else %}
                    {{ also_product.price | money }}
                  {% endif %}
                </span>
              {% endif %}
            </div>
          </div>
          
          <button class="also-see-add-btn" 
                  data-variant-id="{% if upsell_variant %}{{ upsell_variant.id }}{% else %}{{ also_product.selected_or_first_available_variant.id }}{% endif %}"
                  data-original-text="{{ block.settings.button_text }}">
            {{ block.settings.button_text }}
          </button>
        </div>
      </div>
    </a>
  </div>
{% endif %}

{% schema %}
{
  "name": "DK Upsell Product",
  "settings": [
    {
      "type": "header",
      "content": "Display Settings"
    },
    {
      "type": "checkbox",
      "id": "enabled",
      "label": "Enable upsell block",
      "default": true
    },
    {
      "type": "text",
      "id": "title",
      "label": "Custom title",
      "info": "Leave blank to use product title"
    },
    {
      "type": "text",
      "id": "section_heading",
      "label": "Section heading",
      "default": "Also available in",
      "info": "Optional heading above the product"
    },
    {
      "type": "image_picker",
      "id": "custom_image",
      "label": "Custom image",
      "info": "Leave blank to use product featured image"
    },
    {
      "type": "checkbox",
      "id": "show_description",
      "label": "Show product description",
      "default": false
    },
    {
      "type": "header",
      "content": "Section Heading Style"
    },
    {
      "type": "font_picker",
      "id": "heading_font",
      "label": "Heading font",
      "default": "work_sans_n4"
    },
    {
      "type": "range",
      "id": "heading_font_size",
      "min": 12,
      "max": 48,
      "step": 1,
      "unit": "px",
      "label": "Heading font size",
      "default": 18
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading color",
      "default": "#000000"
    },
    {
      "type": "select",
      "id": "heading_text_transform",
      "label": "Heading text transform",
      "default": "none",
      "options": [
        {"value": "none", "label": "None"},
        {"value": "uppercase", "label": "Uppercase"},
        {"value": "lowercase", "label": "Lowercase"},
        {"value": "capitalize", "label": "Capitalize"}
      ]
    },
    {
      "type": "select",
      "id": "heading_alignment",
      "label": "Heading alignment",
      "default": "left",
      "options": [
        {"value": "left", "label": "Left"},
        {"value": "center", "label": "Center"},
        {"value": "right", "label": "Right"}
      ]
    },
    {
      "type": "range",
      "id": "heading_spacing",
      "min": 0,
      "max": 40,
      "step": 2,
      "unit": "px",
      "label": "Spacing below heading",
      "default": 12
    },
    {
      "type": "header",
      "content": "Product Title Style"
    },
    {
      "type": "font_picker",
      "id": "title_font",
      "label": "Title font",
      "default": "work_sans_n4"
    },
    {
      "type": "range",
      "id": "title_font_size",
      "min": 10,
      "max": 24,
      "step": 1,
      "unit": "px",
      "label": "Title font size",
      "default": 13
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Title color",
      "default": "#000000"
    },
    {
      "type": "select",
      "id": "title_text_transform",
      "label": "Title text transform",
      "default": "uppercase",
      "options": [
        {"value": "none", "label": "None"},
        {"value": "uppercase", "label": "Uppercase"},
        {"value": "lowercase", "label": "Lowercase"},
        {"value": "capitalize", "label": "Capitalize"}
      ]
    },
    {
      "type": "header",
      "content": "Card Styling"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Card background color",
      "default": "#f8f8f8"
    },
    {
      "type": "range",
      "id": "card_border_radius",
      "min": 0,
      "max": 20,
      "step": 1,
      "unit": "px",
      "label": "Card border radius",
      "default": 8
    },
    {
      "type": "range",
      "id": "card_border_width",
      "min": 0,
      "max": 5,
      "step": 1,
      "unit": "px",
      "label": "Card border width",
      "default": 0
    },
    {
      "type": "color",
      "id": "card_border_color",
      "label": "Card border color",
      "default": "#e0e0e0"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text",
      "default": "+ ADD"
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Top padding",
      "default": 16
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Bottom padding",
      "default": 16
    },
    {
      "type": "range",
      "id": "padding-inline-start",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Left padding",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-inline-end",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Right padding",
      "default": 0
    },
    {
      "type": "header",
      "content": "Debug"
    },
    {
      "type": "checkbox",
      "id": "show_debug",
      "label": "Show debug info",
      "default": false,
      "info": "Enable to troubleshoot metafield setup"
    }
  ]
}
{% endschema %}

{% stylesheet %}
  .dk-upsell-block {
    --upsell-border-radius: 8px;
    --upsell-primary-color: #3772F6;
    --upsell-text-color: #000;
    --upsell-secondary-color: #666;
  }

  .product-also-see-container {
    margin: 0;
  }

  .product-also-see-item {
    display: flex;
    align-items: center;
    gap: 0;
    padding: 16px;
    position: relative;
    border-radius: var(--upsell-border-radius);
    transition: transform 0.2s ease;
  }

  .product-also-see-item:hover {
    transform: translateY(-1px);
  }

  .also-see-image {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 4px;
    flex-shrink: 0;
  }

  .also-see-content {
    flex: 1;
    padding: 0 80px 0 12px;
    min-width: 0; /* Allows text to truncate properly */
  }

  .also-see-title {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin: 0 0 5px 0;
    color: var(--upsell-text-color);
    line-height: 1.2;
  }

  .also-see-description {
    font-size: 0.75rem;
    line-height: 1.3;
    margin: 0 0 8px 0;
    color: var(--upsell-secondary-color);
  }

  .also-see-price {
    margin: 0;
  }

  .compare-price {
    text-decoration: line-through;
    color: #999;
    margin-right: 8px;
    font-size: 0.85rem;
  }

  .price {
    color: var(--upsell-text-color);
    font-size: 0.85rem;
    font-weight: 600;
  }

  .also-see-add-btn {
    background: #fff;
    border: 2px solid var(--upsell-primary-color);
    border-radius: 4px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
    position: absolute;
    right: 16px;
    top: 16px;
    padding: 6px 12px;
    min-height: auto;
    color: var(--upsell-primary-color);
    font-weight: 700;
    box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.08);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .also-see-add-btn:hover {
    background: var(--upsell-primary-color);
    color: #fff;
    transform: translateY(-1px);
    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.12);
  }

  .also-see-add-btn:active {
    transform: translateY(0);
  }

  .also-see-add-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  /* Mobile optimizations */
  @media (max-width: 767px) {
    .also-see-image {
      width: 70px;
      height: 70px;
    }

    .also-see-content {
      padding: 0 70px 0 10px;
    }

    .also-see-title {
      font-size: 0.75rem;
    }

    .also-see-description {
      font-size: 0.7rem;
    }

    .also-see-add-btn {
      right: 12px;
      top: 12px;
      padding: 4px 8px;
      font-size: 0.7rem;
    }

    .product-also-see-item {
      padding: 12px;
    }
  }
{% endstylesheet %}

<script>
  (() => {
    function initUpsellButtons() {
      document.querySelectorAll('.also-see-add-btn').forEach(button => {
        if (button.hasAttribute('data-upsell-initialized')) return;
        button.setAttribute('data-upsell-initialized', 'true');
        
        button.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          const variantId = this.getAttribute('data-variant-id');
          const originalText = this.getAttribute('data-original-text') || '+ ADD';
          
          if (!variantId) {
            console.error('No variant ID found');
            return;
          }
          
          // Add loading state
          this.disabled = true;
          this.textContent = 'Adding...';
          
          fetch('/cart/add.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify({
              items: [{
                id: variantId,
                quantity: 1
              }]
            })
          })
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
          })
          .then(() => {
            // Success state
            this.textContent = '✓ Added';
            this.style.background = '#10b981';
            this.style.borderColor = '#10b981';
            this.style.color = '#fff';
            
            // Trigger cart update event
            document.dispatchEvent(new CustomEvent('cart:updated'));
            
            // Reset button after delay
            setTimeout(() => {
              this.textContent = originalText;
              this.style.background = '';
              this.style.borderColor = '';
              this.style.color = '';
              this.disabled = false;
            }, 2000);
          })
          .catch(error => {
            console.error('Add to cart error:', error);
            this.textContent = 'Error';
            this.style.background = '#ef4444';
            this.style.borderColor = '#ef4444';
            this.style.color = '#fff';
            
            setTimeout(() => {
              this.textContent = originalText;
              this.style.background = '';
              this.style.borderColor = '';
              this.style.color = '';
              this.disabled = false;
            }, 2000);
          });
        });
      });
    }

    // Initialize on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initUpsellButtons);
    } else {
      initUpsellButtons();
    }

    // Re-initialize if content changes (for dynamic content)
    document.addEventListener('shopify:section:load', initUpsellButtons);
  })();
</script>
{% comment %}
  Combo Pack Selector Block
  Added by DK on 2025-10-25
  
  Displays combo pack options on product pages based on product metafields
  Allows customers to switch between single product and combo variants
{% endcomment %}

{%- assign combos = product.metafields.custom.combo_products.value -%}
{%- assign combo_heading = product.metafields.custom.combo_heading.value | default: 'Combo Packs' -%}

{% comment %} DEBUG: Always show block for testing {% endcomment %}
<div style="background: #ffeb3b; padding: 15px; margin: 10px; border: 2px solid #f57c00;">
  <strong>ðŸ”§ DK Combo Pack Block - DEBUG MODE</strong><br>
  Block is loading correctly!<br>
  Combos found: {{ combos.size | default: 0 }}<br>
  Metafield data: {{ combos | json }}<br>
  Product handle: {{ product.handle }}<br>
</div>

{%- if combos and combos.size > 0 -%}
  <div 
    id="ComboPacks" 
    class="pdp-option-block"
    style="{% render 'spacing-style', settings: block.settings %}"
  >
    <div class="mb-2 text-sm font-medium">{{ combo_heading | escape }}</div>
    <div class="grid grid-cols-2 gap-3">
      {%- for combo_product in combos -%}
        <button
          type="button"
          class="js-cross-product dk-combo-card block text-left border rounded overflow-hidden transition-all duration-200 hover:shadow-md"
          data-url="{{ combo_product.url }}"
          data-product-id="{{ combo_product.id }}"
          aria-label="Switch to {{ combo_product.title | escape }}"
        >
          <div class="aspect-square overflow-hidden">
            {%- if combo_product.featured_image -%}
              <img
                src="{{ combo_product.featured_image | image_url: width: 480 }}"
                alt="{{ combo_product.featured_image.alt | escape }}"
                loading="lazy"
                class="w-full h-full object-cover"
                width="240"
                height="240"
              >
            {%- else -%}
              <div class="w-full h-full bg-gray-100 flex items-center justify-center">
                <span class="text-gray-400 text-sm">No image</span>
              </div>
            {%- endif -%}
          </div>
          <div class="p-3">
            <div class="text-xs text-neutral-600 line-clamp-2 mb-1">
              {%- assign short_title = combo_product.metafields.custom.short_title.value -%}
              {%- if short_title -%}
                {{ short_title | escape }}
              {%- else -%}
                {{ combo_product.title | escape }}
              {%- endif -%}
            </div>
            <div class="text-sm font-semibold">
              {%- if combo_product.price_varies -%}
                From {{ combo_product.price_min | money }}
              {%- else -%}
                {{ combo_product.price | money }}
              {%- endif -%}
            </div>
            {%- if combo_product.available == false -%}
              <span class="inline-block mt-1 px-2 py-1 text-xs bg-red-100 text-red-600 rounded">
                Sold out
              </span>
            {%- endif -%}
          </div>
        </button>
      {%- endfor -%}
    </div>
  </div>

  {% comment %} Add loading state for better UX {% endcomment %}
  <div id="combo-loading" class="hidden text-center py-4">
    <div class="inline-flex items-center">
      <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-gray-900"></div>
      <span class="ml-2 text-sm text-gray-600">Loading...</span>
    </div>
  </div>
{%- endif -%}

{% schema %}
{
  "name": "DK Combo Pack Selector",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Top padding",
      "default": 12
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Bottom padding",
      "default": 12
    },
    {
      "type": "range",
      "id": "padding-inline-start",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Left padding",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-inline-end",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Right padding",
      "default": 0
    }
  ]
}
{% endschema %}

{% comment %} Inline styles for better theme compatibility {% endcomment %}
{% stylesheet %}
  .dk-combo-card {
    background: white;
    border: 1px solid #e5e5e5;
    cursor: pointer;
  }

  .dk-combo-card:hover {
    border-color: #d1d5db;
    transform: translateY(-1px);
  }

  .dk-combo-card:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  @media (max-width: 640px) {
    #ComboPacks .grid {
      grid-template-columns: 1fr;
      gap: 0.75rem;
    }
    
    .dk-combo-card {
      display: flex;
      align-items: center;
    }
    
    .dk-combo-card .aspect-square {
      width: 80px;
      height: 80px;
      flex-shrink: 0;
    }
    
    .dk-combo-card .p-3 {
      flex: 1;
      padding: 0.75rem;
    }
  }

  /* Animation for smooth transitions */
  .animate-spin {
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }
{% endstylesheet %}